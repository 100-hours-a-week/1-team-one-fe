name: Frontend Deploy Template

on:
  workflow_call:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ (dev, staging, production)'
        required: true
        type: string
      artifact_name_prefix:
        description: 'Artifact ì´ë¦„ prefix (frontend-dev, frontend-staging, frontend-production)'
        required: true
        type: string
      pr_number:
        description: 'PR ë²ˆí˜¸'
        required: true
        type: number
      commit_sha:
        description: 'ì»¤ë°‹ SHA'
        required: true
        type: string
      base_ref:
        description: 'ë² ì´ìŠ¤ ë¸Œëœì¹˜ (main, develop)'
        required: true
        type: string
      pr_title:
        description: 'PR ì œëª©'
        required: true
        type: string
      actor:
        description: 'Triggered by (GitHub ì‚¬ìš©ì)'
        required: true
        type: string
      repository:
        description: 'Repository ì´ë¦„'
        required: true
        type: string
      run_id:
        description: 'GitHub Actions Run ID'
        required: true
        type: string
      create_tag:
        description: 'ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ìƒì„± ì—¬ë¶€ (productionë§Œ true)'
        required: false
        type: boolean
        default: false
    secrets:
      SERVER_USER:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      DISCORD_WEBHOOK_URL:
        required: true
      DISCORD_ROLE_FRONTEND:
        required: true
      DISCORD_ROLE_FRONTEND_ONCALL:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (íƒœê¹…ìš©)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Git Tag ìƒì„± ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”í•¨

      # 2. Artifact Download
      - name: Download build artifact
        uses: dawidd6/action-download-artifact@v6
        # ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì˜ Artifactë„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ì»¤ìŠ¤í…€ ì•¡ì…˜
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: frontend-ci-cd.yml # Artifactë¥¼ ìƒì„±í•œ ì›Œí¬í”Œë¡œìš° íŒŒì¼ëª…
          pr: ${{ inputs.pr_number }} # PR ë²ˆí˜¸ë¡œ ê²€ìƒ‰
          workflow_conclusion: success # ì„±ê³µí•œ ì›Œí¬í”Œë¡œìš°ë§Œ ê²€ìƒ‰
          name_is_regexp: true # Artifact ì´ë¦„ì„ ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ê²€ìƒ‰ trueëŠ” íŒ¨í„´ ë§¤ì¹­ ê°€ëŠ¥
          name: '${{ inputs.artifact_name_prefix }}-.*'
          path: ./artifacts

      # 3. íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ tar.gz íŒŒì¼ëª… ë³€ê²½
      - name: Prepare artifact with timestamp
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          cd artifacts
          cd $(ls -d ${{ inputs.artifact_name_prefix }}-* | head -n 1)
          TAR_FILE=$(ls *.tar.gz | head -n 1)
          mv $TAR_FILE ../../frontend-${TIMESTAMP}.tar.gz
          cd ../..
          echo "TAR_FILENAME=frontend-${TIMESTAMP}.tar.gz" >> $GITHUB_ENV
          echo "DEPLOY_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      # 4. release/ ë””ë ‰í† ë¦¬ë¡œ tar.gz ì „ì†¡
      - name: Transfer artifact to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: 'frontend-${{ env.DEPLOY_TIMESTAMP }}.tar.gz' # ì „ì†¡í•  íŒŒì¼
          target: '~/frontend/release/'
          strip_components: 0 # ê²½ë¡œì—ì„œ ì œê±°í•  ë””ë ‰í† ë¦¬ ê¹Šì´: ì§€ê¸ˆ ì´ë¯¸ íŒŒì¼ëª…ë§Œ ìˆìŒ
          # 0: ì›ë³¸ ê²½ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€
          # 1: ì²« ë²ˆì§¸ ë””ë ‰í† ë¦¬ ì œê±° (artifacts/file.tar.gz â†’ file.tar.gz)

      # 5. ë°°í¬ ì‹¤í–‰ (ì••ì¶• í•´ì œ + PM2 ì¬ì‹œì‘ ë°©ì‹)
      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # NVM ë¡œë“œ (PM2 ê²½ë¡œ ì„¤ì •)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  

            FRONTEND_DIR="/home/ubuntu/frontend"
            RELEASE_DIR="$FRONTEND_DIR/release"
            NEW_TAR="$RELEASE_DIR/frontend-${{ env.DEPLOY_TIMESTAMP }}.tar.gz"
            APP_DIR="$FRONTEND_DIR/app"

            echo "1. ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€"
            pm2 stop frontend || true

            echo "2. ê¸°ì¡´ íŒŒì¼ ë°±ì—…"
            if [ -d "$APP_DIR" ]; then
              mv $APP_DIR ${APP_DIR}_backup_$(date +%Y%m%d%H%M%S)
            fi

            echo "3. ìƒˆ ë²„ì „ ì••ì¶• í•´ì œ"
            mkdir -p $APP_DIR
            tar -xzf $NEW_TAR -C $APP_DIR

            echo "4. ëª¨ë…¸ë ˆí¬ êµ¬ì¡° ì°¾ê¸°"
            if [ -d "$APP_DIR/1-team-one-fe/apps/web" ]; then
              ACTUAL_APP_DIR="$APP_DIR/1-team-one-fe/apps/web"
            elif [ -d "$APP_DIR/apps/web" ]; then
              ACTUAL_APP_DIR="$APP_DIR/apps/web"
            else
              echo "ERROR: Cannot find app directory"
              ls -la $APP_DIR
              exit 1
            fi

            echo "Found app at: $ACTUAL_APP_DIR"

            echo "5. PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘"
            cd $ACTUAL_APP_DIR
            pm2 start server.js --name frontend --time || pm2 restart frontend

            echo "6. PM2 ìƒíƒœ í™•ì¸"
            pm2 status
            pm2 save

            echo "7. í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ëŒ€ê¸°"
            sleep 10

      # 6. Health Check
      - name: Health Check
        id: healthcheck
        uses: appleboy/ssh-action@v1.0.0
        # continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "Health Check ì‹œì‘"
            MAX_RETRY=10
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
              if curl -f -s http://localhost:3000 > /dev/null; then
                echo "Health check passed!"
                exit 0
              fi

              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "Retry $RETRY_COUNT/$MAX_RETRY..."
              sleep 5
            done

            # fail ì‹œ ë¡¤ë°± + ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì¶”ê°€ ì˜ˆì •

            echo "Health check failed!"
            pm2 logs frontend --lines 30 --nostream
            exit 1

      # 7. ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ìƒì„±
      - name: Create Semantic Version Tag
        if: |
          steps.healthcheck.outcome == 'success' && inputs.create_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ frontend-v0.0.0)
          # git describe --tags: ê°€ì¥ ê°€ê¹Œìš´ íƒœê·¸ ì°¾ê¸°
          # --abbrev=0: ì»¤ë°‹ í•´ì‹œ í‘œì‹œ ì•ˆ í•¨ (íƒœê·¸ë§Œ)
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "frontend-v*.*.*" 2>/dev/null || echo "frontend-v0.0.0")
          echo "Latest tag: $LATEST_TAG"

          # ë²„ì „ íŒŒì‹±
          VERSION=${LATEST_TAG#frontend-v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Patch ë²„ì „ ìë™ ì¦ê°€ (0.0.0 â†’ 0.0.1)
          # ë‹¨ íŒ¨ì¹˜ë²„ì „ì— ëŒ€í•´ì„œë§Œ ê°€ëŠ¥, ë©”ì´ì €ì˜ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”
          PATCH=$((PATCH + 1))
          NEW_VERSION="frontend-v${MAJOR}.${MINOR}.${PATCH}"

          echo "New version: $NEW_VERSION"

          # Git ì„¤ì • (ì»¤ë°‹ ì‘ì„±ì ì •ë³´)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git tag -a $NEW_VERSION -m "Release $NEW_VERSION

          Deploy Timestamp: ${{ env.DEPLOY_TIMESTAMP }}
          TAR File: ${{ env.TAR_FILENAME }}
          Commit: ${{ inputs.commit_sha }}
          PR: #${{ inputs.pr_number }}
          Environment: ${{ inputs.environment }}"

          git push origin $NEW_VERSION
          echo "DEPLOY_TAG=$NEW_VERSION" >> $GITHUB_ENV
          echo "Tag created: $NEW_VERSION"

      # 8. ì˜¤ë˜ëœ release/ íŒŒì¼ ì •ë¦¬ (ë°°í¬ ì„±ê³µ ì‹œ)
      - name: Cleanup Old Releases
        if: steps.healthcheck.outcome == 'success'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            RELEASE_DIR="/home/ubuntu/frontend/release"

            echo "Cleanup old releases"

            # ìµœê·¼ 5ê°œë§Œ ìœ ì§€, ë‚˜ë¨¸ì§€ ì‚­ì œ
            cd $RELEASE_DIR
            OLD_TARS=$(ls -t frontend-*.tar.gz 2>/dev/null | tail -n +6)

            if [ -n "$OLD_TARS" ]; then
              echo "Removing old releases:"
              echo "$OLD_TARS" | xargs -r rm -v
            else
              echo "No old releases to clean up"
            fi

            # ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ (7ì¼ ì´ìƒ)
            find /home/ubuntu/frontend/app_backup_* -mtime +7 -exec rm -rf {} \; 2>/dev/null || true

      # í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (KST)
      - name: Get Current Time
        if: always()
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: '+09:00' # í•œêµ­ ì‹œê°„
          timezone: 'Asia/Seoul'

      # 9. Discord ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… ${{ inputs.environment }} FE ë°°í¬(CD) ì„±ê³µ", 
              "color": 5763719,
              "fields": [
                {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                {"name": "Version", "value": "${{ env.DEPLOY_TAG || 'N/A' }}", "inline": true},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} FE ë°°í¬ ì™„ë£Œ! <@&${{ secrets.DISCORD_ROLE_FRONTEND }}>'

      # 10. Discord ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ ${{ inputs.environment }} FE ë°°í¬(CD) ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} FE ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ í™•ì¸ í•„ìš” <@&${{ secrets.DISCORD_ROLE_FRONTEND_ONCALL }}>'
