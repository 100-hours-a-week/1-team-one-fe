name: Frontend CI/CD

permissions:
  contents: write
  pull-requests: read

on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [develop, main]
    paths:
      # í•µì‹¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ
      - 'apps/web/**'
      - 'packages/**'

      # ì˜ì¡´ì„± ê´€ë¦¬
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'pnpm-workspace.yaml'

      # ë¹Œë“œ ì„¤ì •
      - 'turbo.json'
      - 'tooling/**'
      - 'eslint.config.mjs'

      # íŒ¨í‚¤ì§€ ê´€ë¦¬ì ì„¤ì •
      - '.npmrc'

      # CI/CD ì›Œí¬í”Œë¡œìš°
      - '.github/workflows/frontend-ci-cd.yml'
      - '.github/workflows/frontend-deploy-template.yml'

jobs:
  build-and-test: # PR ëŒ€ìƒ: Full CI (Build â†’ Test â†’ Artifact)
    # closedëŠ” ì œì™¸ (ë³‘í•© ì‹œì—ëŠ” CDë§Œ ì‹¤í–‰)
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. pnpm ì„¤ì¹˜
      - name: Install pnpm
        uses: pnpm/action-setup@v4

      # 3. Node.js í™˜ê²½ ì„¤ì • (pnpm ìºì‹± í¬í•¨)
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '24.13.0'
          cache: 'pnpm' # ì˜ì¡´ì„±: ~/.pnpm-store ìºì‹±

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. Turbo ë¹Œë“œ ìºì‹œ ë³µì›
      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.event.pull_request.head.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # 6. Next.js ë¹Œë“œ ìºì‹œ ë³µì›
      - name: Restore Next.js build cache
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-${{ hashFiles('apps/web/**/*.{js,ts,jsx,tsx}', 'packages/**/*.{js,ts,jsx,tsx}') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-

      # Phase 1: Lint (ì ì§„ì  ê°œì„  ë°©ì‹ - max warningsë¥¼ ì¤„ì—¬ ë‚˜ê°„ë‹¤.)
      # ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬, í…ŒìŠ¤íŠ¸ íŒŒì¼ ë“±ì€ .eslintrc.jsì—ì„œ ì¶”ê°€ ì„¤ì •
      #- name: Run ESLint
      #  run: pnpm lint -- --max-warnings 50 # Next.js ë‚´ì¥ ESLint ì„¤ì • ì‚¬ìš©

      # Phase 2: Build (Export env first)
      - name: Export web env
        shell: bash
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "${{ secrets.WEB_ENV_STAGING }}" >> "$GITHUB_ENV"
          else
            echo "${{ secrets.WEB_ENV_DEV }}" >> "$GITHUB_ENV"
          fi

      - name: Build Next.js application
        run: pnpm turbo build --filter=web

      # Phase 3: Test
      #- name: Run unit tests
      #  run: pnpm test -- --passWithNoTests

      # Phase 4: Artifact Preparation (ëª¨ë…¸ë ˆí¬ ê²½ë¡œ ì²˜ë¦¬)
      - name: Bundle Artifacts
        working-directory: apps/web
        run: |
          STANDALONE_ROOT=".next/standalone"

          # ëª¨ë…¸ë ˆí¬ ì¤‘ì²© êµ¬ì¡° ì°¾ê¸°
          if [ -d "$STANDALONE_ROOT/1-team-one-fe/apps/web" ]; then
            APP_DIR="$STANDALONE_ROOT/1-team-one-fe/apps/web"
          elif [ -d "$STANDALONE_ROOT/apps/web" ]; then
            APP_DIR="$STANDALONE_ROOT/apps/web"
          else
            echo "ERROR: Cannot find standalone app directory"
            ls -la $STANDALONE_ROOT
            exit 1
          fi

          mkdir -p $APP_DIR/.next
          cp -r .next/static $APP_DIR/.next/
          cp -r public $APP_DIR/

          cd $STANDALONE_ROOT
          tar -czf $GITHUB_WORKSPACE/frontend.tar.gz .
          ls -lh $GITHUB_WORKSPACE/frontend.tar.gz

      # Phase 5: Artifact Upload
      - name: Upload Dev artifact
        if: github.base_ref == 'develop'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dev-${{ github.event.pull_request.head.sha }}
          path: frontend.tar.gz
          retention-days: 14
          compression-level: 0 # tar.gzëŠ” ì´ë¯¸ ì••ì¶•ë¨

      - name: Upload Staging artifact
        if: github.base_ref == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-staging-${{ github.event.pull_request.head.sha }}
          path: frontend.tar.gz
          retention-days: 14
          compression-level: 0

      # í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (KST)
      - name: Get Current Time
        if: always()
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: '+09:00' # í•œêµ­ ì‹œê°„
          timezone: 'Asia/Seoul'

      # Phase 6: Discord ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… FE CI ì„±ê³µ",
              "color": 5763719,
              "fields": [
                {"name": "Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "Merge To", "value": "${{ github.base_ref }}", "inline": false},
                {"name": "Triggered By", "value": "${{ github.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. <@&${{ secrets.DISCORD_ROLE_FRONTEND }}>'

      # Phase 6: Discord ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ FE CI ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                {"name": "Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "Merge To", "value": "${{ github.base_ref }}", "inline": false},
                {"name": "Triggered By", "value": "${{ github.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. <@&${{ secrets.DISCORD_ROLE_FRONTEND_ONCALL }}> '

  # Dev í™˜ê²½ ë°°í¬ (develop ë¸Œëœì¹˜ merge ì‹œ)
  deploy-dev:
    if: github.event.pull_request.merged == true && github.base_ref == 'develop'
    uses: ./.github/workflows/frontend-deploy-template.yml
    with:
      environment: dev
      artifact_name_prefix: frontend-dev
      # server_host: ${{ secrets.DEV_SERVER_HOST }}
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.event.pull_request.head.sha }}
      base_ref: ${{ github.base_ref }}
      pr_title: ${{ github.event.pull_request.title }}
      actor: ${{ github.actor }}
      repository: ${{ github.repository }}
      run_id: ${{ github.run_id }}
      create_tag: false
    secrets: inherit

  # Staging í™˜ê²½ ë°°í¬ (main ë¸Œëœì¹˜ merge ì‹œ, ìë™)
  deploy-staging:
    if: github.event.pull_request.merged == true && github.base_ref == 'main'
    uses: ./.github/workflows/frontend-deploy-template.yml
    with:
      environment: staging
      artifact_name_prefix: frontend-staging
      # server_host: ${{ secrets.STAGING_SERVER_HOST }}
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.event.pull_request.head.sha }}
      base_ref: ${{ github.base_ref }}
      pr_title: ${{ github.event.pull_request.title }}
      actor: ${{ github.actor }}
      repository: ${{ github.repository }}
      run_id: ${{ github.run_id }}
      create_tag: false
    secrets: inherit

  # Production CI: ë¹Œë“œë§Œ (Staging ì„±ê³µ í›„)
  prod-ci:
    needs: [deploy-staging]
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # 2. pnpm ì„¤ì¹˜
      - name: Install pnpm
        uses: pnpm/action-setup@v4

      # 3. Node.js í™˜ê²½ ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '24.13.0'
          cache: 'pnpm'

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. Turbo ë¹Œë“œ ìºì‹œ ë³µì›
      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.event.pull_request.head.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # 6. Export web env (production)
      - name: Export web env (production)
        shell: bash
        run: |
          echo "${{ secrets.WEB_ENV_PROD }}" >> "$GITHUB_ENV"

      # 7. Production ë¹Œë“œ
      - name: Build for Production
        run: pnpm turbo build --filter=web

      # 8. Artifact ì¤€ë¹„
      - name: Bundle Production Artifacts
        working-directory: apps/web
        run: |
          STANDALONE_ROOT=".next/standalone"

          if [ -d "$STANDALONE_ROOT/1-team-one-fe/apps/web" ]; then
            APP_DIR="$STANDALONE_ROOT/1-team-one-fe/apps/web"
          elif [ -d "$STANDALONE_ROOT/apps/web" ]; then
            APP_DIR="$STANDALONE_ROOT/apps/web"
          else
            echo "ERROR: Cannot find standalone app directory"
            ls -la $STANDALONE_ROOT
            exit 1
          fi

          mkdir -p $APP_DIR/.next
          cp -r .next/static $APP_DIR/.next/
          cp -r public $APP_DIR/

          cd $STANDALONE_ROOT
          tar -czf $GITHUB_WORKSPACE/frontend.tar.gz .
          ls -lh $GITHUB_WORKSPACE/frontend.tar.gz

      # 9. Upload Production artifact
      - name: Upload Production artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-production-${{ github.event.pull_request.head.sha }}
          path: frontend.tar.gz
          retention-days: 14
          compression-level: 0

  # Production í™˜ê²½ ë°°í¬ (prod-ci ì„±ê³µ í›„ ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”)
  deploy-production:
    needs: [prod-ci]
    uses: ./.github/workflows/frontend-deploy-template.yml
    with:
      environment: production # GitHub Environmentì—ì„œ Required reviewers ì„¤ì • í•„ìˆ˜
      artifact_name_prefix: frontend-production
      # server_host: ${{ secrets.PROD_SERVER_HOST }}
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.event.pull_request.head.sha }}
      base_ref: ${{ github.base_ref }}
      pr_title: ${{ github.event.pull_request.title }}
      actor: ${{ github.actor }}
      repository: ${{ github.repository }}
      run_id: ${{ github.run_id }}
      create_tag: true # Productionë§Œ ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ìƒì„±
    secrets: inherit
